<html lang="es" class="scroll-smooth" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BlackBox - Nómina y Asistencias Luconi</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
  /* Scrollbar for tables */
  .scrollbar-thin::-webkit-scrollbar {
    height: 6px;
    width: 6px;
  }
  .scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: rgba(100, 116, 139, 0.5);
    border-radius: 10px;
  }
  /* Dark mode styles */
  [data-theme="dark"] {
    --bg-color: #1f2937;
    --text-color: #d1d5db;
    --header-bg: #111827;
    --header-text: #9ca3af;
    --table-header-bg: #374151;
    --table-header-text: #d1d5db;
    --input-bg: #374151;
    --input-border: #4b5563;
    --input-text: #d1d5db;
    --btn-bg: #2563eb;
    --btn-hover-bg: #1d4ed8;
    --btn-text: #f9fafb;
    --border-color: #4b5563;
  }
  [data-theme="dark"] body {
    background-color: var(--bg-color);
    color: var(--text-color);
  }
  [data-theme="dark"] header, [data-theme="dark"] footer {
    background-color: var(--header-bg);
    color: var(--header-text);
  }
  [data-theme="dark"] table thead {
    background-color: var(--table-header-bg);
    color: var(--table-header-text);
  }
  [data-theme="dark"] input, [data-theme="dark"] select, [data-theme="dark"] textarea {
    background-color: var(--input-bg);
    border-color: var(--input-border);
    color: var(--input-text);
  }
  [data-theme="dark"] input::placeholder, [data-theme="dark"] textarea::placeholder {
    color: #9ca3af;
  }
  [data-theme="dark"] button {
    background-color: var(--btn-bg);
    color: var(--btn-text);
  }
  [data-theme="dark"] button:hover {
    background-color: var(--btn-hover-bg);
  }
  [data-theme="dark"] .border-gray-300 {
    border-color: var(--border-color);
  }
  [data-theme="dark"] .bg-white {
    background-color: var(--header-bg);
  }
  [data-theme="dark"] .text-gray-500 {
    color: #9ca3af;
  }
  [data-theme="dark"] .text-gray-600 {
    color: #9ca3af;
  }
  [data-theme="dark"] .text-gray-700 {
    color: #d1d5db;
  }
  [data-theme="dark"] .text-gray-800 {
    color: #e5e7eb;
  }
  [data-theme="dark"] .shadow {
    box-shadow: 0 0 10px rgba(0,0,0,0.7);
  }
</style>
</head>
<body class="min-h-screen flex flex-col bg-gray-50 text-gray-800" data-theme="light">

<header class="bg-white shadow sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
    <h1 class="text-xl font-bold text-indigo-700 flex items-center gap-2 select-none" aria-label="BlackBox - Nómina y Asistencias Luconi">
      <i class="fas fa-users-cog" aria-hidden="true"></i> BlackBox - Nómina y Asistencias Luconi
    </h1>
    <nav class="hidden md:flex space-x-8 text-gray-600 font-semibold" role="navigation" aria-label="Menú principal">
      <button data-tab="employees" class="tab-btn border-b-4 border-indigo-700 pb-1 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-current="page">Empleados</button>
      <button data-tab="attendance" class="tab-btn border-b-4 border-transparent pb-1 hover:border-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Asistencias</button>
      <button data-tab="reports" class="tab-btn border-b-4 border-transparent pb-1 hover:border-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Reportes</button>
      <button data-tab="settings" class="tab-btn border-b-4 border-transparent pb-1 hover:border-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Configuración</button>
    </nav>
    <div class="md:hidden">
      <label for="mobileTabSelector" class="sr-only">Seleccionar módulo</label>
      <select id="mobileTabSelector" class="border border-gray-300 rounded-md p-1 text-gray-700 font-semibold focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Seleccionar módulo">
        <option value="employees" selected>Empleados</option>
        <option value="attendance">Asistencias</option>
        <option value="reports">Reportes</option>
        <option value="settings">Configuración</option>
      </select>
    </div>
    <button id="toggleDarkMode" aria-label="Alternar modo oscuro" class="ml-4 text-gray-600 hover:text-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded p-1" title="Alternar modo oscuro">
      <i class="fas fa-moon"></i>
    </button>
  </div>
</header>

<main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6" role="main">

  <!-- Empleados -->
  <section id="employees" class="tab-content" tabindex="0" aria-label="Módulo de gestión de empleados">
    <h2 class="text-2xl font-bold mb-4 text-indigo-700 flex items-center gap-2"><i class="fas fa-user-plus" aria-hidden="true"></i> Registro y Gestión de Empleados</h2>

    <form id="employeeForm" class="bg-white p-6 rounded-lg shadow mb-8 grid grid-cols-1 md:grid-cols-3 gap-6" aria-describedby="employeeFormDesc" novalidate>
      <p id="employeeFormDesc" class="sr-only">Formulario para agregar o editar empleados. Todos los campos son obligatorios excepto donde se indique.</p>
      <div>
        <label for="empName" class="block font-semibold mb-1">Nombre <span class="text-red-600">*</span></label>
        <input type="text" id="empName" name="empName" required pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ\s\-]{2,30}$" title="Solo letras, espacios y guiones, 2 a 30 caracteres" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ej: Juan" autocomplete="given-name" />
      </div>
      <div>
        <label for="empLastName" class="block font-semibold mb-1">Apellido <span class="text-red-600">*</span></label>
        <input type="text" id="empLastName" name="empLastName" required pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ\s\-]{2,30}$" title="Solo letras, espacios y guiones, 2 a 30 caracteres" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ej: Pérez" autocomplete="family-name" />
      </div>
      <div>
        <label for="empDNI" class="block font-semibold mb-1">DNI (único) <span class="text-red-600">*</span></label>
        <input type="text" id="empDNI" name="empDNI" required pattern="^\d{6,10}$" title="Solo números, 6 a 10 dígitos" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ej: 12345678" autocomplete="off" inputmode="numeric" />
      </div>
      <div>
        <label for="empDate" class="block font-semibold mb-1">Fecha de ingreso <span class="text-red-600">*</span></label>
        <input type="date" id="empDate" name="empDate" required max="" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
      </div>
      <div>
        <label for="empPosition" class="block font-semibold mb-1">Puesto <span class="text-red-600">*</span></label>
        <input type="text" id="empPosition" name="empPosition" required minlength="2" maxlength="50" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ej: Vendedor" />
      </div>
      <div>
        <label for="empUnit" class="block font-semibold mb-1">Unidad de negocio <span class="text-red-600">*</span></label>
        <select id="empUnit" name="empUnit" required class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-describedby="unitHelp">
          <!-- Options loaded dynamically -->
        </select>
        <p id="unitHelp" class="text-xs text-gray-500 mt-1">Seleccione la unidad de negocio del empleado.</p>
      </div>
      <div class="flex items-end">
        <button type="submit" id="empSubmitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-md transition-colors flex items-center justify-center gap-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-live="polite" aria-atomic="true">
          <i class="fas fa-plus"></i> Agregar Empleado
        </button>
      </div>
    </form>

    <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <input type="text" id="empSearch" placeholder="Buscar por Nombre, Apellido o DNI..." class="border border-gray-300 rounded-md p-2 w-full md:w-1/3 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Buscar empleados por nombre, apellido o DNI" />
      <div class="flex gap-2 flex-wrap">
        <button id="exportEmployeesBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-green-500" aria-label="Exportar nómina a archivo Excel">
          <i class="fas fa-file-excel"></i> Exportar Nómina (.xlsx)
        </button>
        <button id="backupEmployeesBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Descargar respaldo de empleados en JSON">
          <i class="fas fa-download"></i> Descargar Respaldo JSON
        </button>
      </div>
    </div>

    <div class="overflow-x-auto rounded-lg shadow bg-white">
      <table class="min-w-full divide-y divide-gray-200 text-sm" role="table" aria-label="Tabla de empleados">
        <thead class="bg-indigo-100 text-indigo-700 font-semibold">
          <tr>
            <th scope="col" class="px-4 py-3 text-left">Nombre</th>
            <th scope="col" class="px-4 py-3 text-left">Apellido</th>
            <th scope="col" class="px-4 py-3 text-left">DNI</th>
            <th scope="col" class="px-4 py-3 text-left">Fecha de ingreso</th>
            <th scope="col" class="px-4 py-3 text-left">Antigüedad (años)</th>
            <th scope="col" class="px-4 py-3 text-left">Puesto</th>
            <th scope="col" class="px-4 py-3 text-left">Unidad</th>
            <th scope="col" class="px-4 py-3 text-center">Acciones</th>
          </tr>
        </thead>
        <tbody id="employeesTableBody" class="divide-y divide-gray-100" role="rowgroup">
          <!-- Employees rows dynamically inserted -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- Asistencias -->
  <section id="attendance" class="tab-content hidden" tabindex="0" aria-label="Módulo de control de asistencias">
    <h2 class="text-2xl font-bold mb-4 text-indigo-700 flex items-center gap-2"><i class="fas fa-calendar-check" aria-hidden="true"></i> Control de Asistencias</h2>

    <form id="attendanceFilterForm" class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4" aria-label="Filtros de asistencias">
      <input type="text" id="attSearch" placeholder="Buscar por Nombre, Apellido o DNI..." class="border border-gray-300 rounded-md p-2 w-full md:w-1/3 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Buscar empleado por nombre, apellido o DNI" />
      <select id="attUnitFilter" class="border border-gray-300 rounded-md p-2 w-full md:w-1/4 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Filtrar por unidad de negocio">
        <option value="all" selected>Todas las unidades</option>
        <!-- Units loaded dynamically -->
      </select>
      <div class="flex items-center gap-2">
        <label for="attDate" class="font-semibold">Fecha:</label>
        <input type="date" id="attDate" max="" class="border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Seleccionar fecha de asistencia" />
      </div>
      <button id="exportAttendanceBtn" type="button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-green-500" aria-label="Exportar asistencias a archivo Excel">
        <i class="fas fa-file-excel"></i> Exportar Asistencias (.xlsx)
      </button>
    </form>

    <form id="attendanceForm" class="overflow-x-auto rounded-lg shadow bg-white p-4 max-h-[60vh] overflow-y-auto scrollbar-thin" aria-label="Formulario de registro de asistencias" novalidate>
      <table class="min-w-full divide-y divide-gray-200 text-sm" role="table" aria-describedby="attendanceTableDesc">
        <caption id="attendanceTableDesc" class="sr-only">Tabla para registrar el estado de asistencia y observaciones por empleado para la fecha seleccionada.</caption>
        <thead class="bg-indigo-100 text-indigo-700 font-semibold sticky top-0 z-10">
          <tr>
            <th scope="col" class="px-4 py-3 text-left">Nombre</th>
            <th scope="col" class="px-4 py-3 text-left">Apellido</th>
            <th scope="col" class="px-4 py-3 text-left">DNI</th>
            <th scope="col" class="px-4 py-3 text-left">Unidad</th>
            <th scope="col" class="px-4 py-3 text-left">Puesto</th>
            <th scope="col" class="px-4 py-3 text-center">Estado de Asistencia</th>
            <th scope="col" class="px-4 py-3 text-left">Observaciones</th>
          </tr>
        </thead>
        <tbody id="attendanceTableBody" class="divide-y divide-gray-100" role="rowgroup">
          <!-- Attendance rows dynamically inserted -->
        </tbody>
      </table>
      <div class="mt-4 flex justify-end">
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-md flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-live="polite" aria-atomic="true">
          <i class="fas fa-save"></i> Guardar Asistencias
        </button>
      </div>
    </form>
  </section>

  <!-- Reportes -->
  <section id="reports" class="tab-content hidden" tabindex="0" aria-label="Módulo de reportes por empleado">
    <h2 class="text-2xl font-bold mb-4 text-indigo-700 flex items-center gap-2"><i class="fas fa-chart-bar" aria-hidden="true"></i> Reportes de Asistencia</h2>

    <form id="reportFilterForm" class="bg-white p-6 rounded-lg shadow mb-6 grid grid-cols-1 md:grid-cols-4 gap-6 items-end" aria-label="Filtros para generar reportes">
      <div>
        <label for="reportEmpSelect" class="block font-semibold mb-1">Empleado</label>
        <select id="reportEmpSelect" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Seleccionar empleado para reporte">
          <option value="all" selected>Todos los empleados</option>
          <!-- Options loaded dynamically -->
        </select>
      </div>
      <div>
        <label for="reportDateFrom" class="block font-semibold mb-1">Desde</label>
        <input type="date" id="reportDateFrom" max="" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Fecha desde" />
      </div>
      <div>
        <label for="reportDateTo" class="block font-semibold mb-1">Hasta</label>
        <input type="date" id="reportDateTo" max="" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Fecha hasta" />
      </div>
      <div class="flex gap-2 flex-wrap">
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-6 rounded-md flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Generar reporte">
          <i class="fas fa-search"></i> Generar Reporte
        </button>
        <button type="button" id="exportReportBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-md flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-green-500" aria-label="Exportar reporte a Excel">
          <i class="fas fa-file-excel"></i> Exportar XLSX
        </button>
        <button type="button" id="printReportBtn" class="bg-gray-700 hover:bg-gray-900 text-white font-semibold py-2 px-6 rounded-md flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-gray-900" aria-label="Imprimir reporte">
          <i class="fas fa-print"></i> Imprimir / PDF
        </button>
      </div>
    </form>

    <div class="overflow-x-auto rounded-lg shadow bg-white">
      <table class="min-w-full divide-y divide-gray-200 text-sm" role="table" aria-label="Tabla de reporte de asistencias">
        <thead class="bg-indigo-100 text-indigo-700 font-semibold">
          <tr>
            <th scope="col" class="px-4 py-3 text-left">Nombre</th>
            <th scope="col" class="px-4 py-3 text-left">Apellido</th>
            <th scope="col" class="px-4 py-3 text-left">DNI</th>
            <th scope="col" class="px-4 py-3 text-left">Días Asistidos</th>
            <th scope="col" class="px-4 py-3 text-left">Días No Asistidos</th>
            <th scope="col" class="px-4 py-3 text-left">Días Avisados</th>
            <th scope="col" class="px-4 py-3 text-left">Días de Vacaciones</th>
            <th scope="col" class="px-4 py-3 text-left">Porcentaje de Asistencia</th>
          </tr>
        </thead>
        <tbody id="reportTableBody" class="divide-y divide-gray-100">
          <!-- Report rows dynamically inserted -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- Configuración -->
  <section id="settings" class="tab-content hidden" tabindex="0" aria-label="Sección de configuración">
    <h2 class="text-2xl font-bold mb-4 text-indigo-700 flex items-center gap-2"><i class="fas fa-cogs" aria-hidden="true"></i> Configuración</h2>

    <div class="bg-white p-6 rounded-lg shadow mb-8 max-w-md">
      <h3 class="text-lg font-semibold mb-4">Unidades de Negocio</h3>
      <form id="unitForm" class="flex gap-2 mb-4" aria-label="Agregar nueva unidad de negocio">
        <input type="text" id="newUnitName" placeholder="Nueva unidad de negocio" class="flex-grow border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Nombre de nueva unidad de negocio" />
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-live="polite" aria-atomic="true">
          <i class="fas fa-plus"></i> Agregar
        </button>
      </form>
      <ul id="unitsList" class="divide-y divide-gray-200 max-h-60 overflow-y-auto scrollbar-thin" role="list" aria-label="Lista de unidades de negocio">
        <!-- Units dynamically inserted -->
      </ul>
    </div>

    <div class="bg-white p-6 rounded-lg shadow max-w-md">
      <h3 class="text-lg font-semibold mb-4">Base de Datos</h3>
      <button id="resetDataBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-md flex items-center gap-2 focus:outline-none focus:ring-2 focus:ring-red-500" aria-live="polite" aria-atomic="true">
        <i class="fas fa-trash-alt"></i> Resetear Base de Datos
      </button>
      <p class="mt-3 text-sm text-gray-600">Esta acción eliminará todos los empleados, unidades y asistencias guardados localmente.</p>
    </div>
  </section>

</main>

<footer class="bg-white shadow-inner py-4 text-center text-gray-500 text-sm select-none" aria-hidden="true">
  &copy; 2024 Luconi - BlackBox App de Nómina y Asistencias
</footer>

<script>
  // Fecha máxima para inputs date = hoy
  const todayISO = new Date().toISOString().split('T')[0];
  document.querySelectorAll('input[type=date]').forEach(input => input.max = todayISO);

  // Tabs logic
  const tabs = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  const mobileTabSelector = document.getElementById('mobileTabSelector');

  function showTab(tabName) {
    tabContents.forEach(tc => {
      tc.classList.toggle('hidden', tc.id !== tabName);
      if(tc.id === tabName) {
        tc.setAttribute('aria-hidden', 'false');
        tc.focus();
      } else {
        tc.setAttribute('aria-hidden', 'true');
      }
    });
    tabs.forEach(t => {
      t.classList.toggle('border-indigo-700', t.dataset.tab === tabName);
      t.classList.toggle('border-transparent', t.dataset.tab !== tabName);
      t.setAttribute('aria-current', t.dataset.tab === tabName ? 'page' : 'false');
    });
    if(mobileTabSelector) mobileTabSelector.value = tabName;
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      showTab(tab.dataset.tab);
    });
  });

  if(mobileTabSelector){
    mobileTabSelector.addEventListener('change', e => {
      showTab(e.target.value);
    });
  }

  showTab('employees');

  // Dark mode toggle
  const toggleDarkModeBtn = document.getElementById('toggleDarkMode');
  toggleDarkModeBtn.addEventListener('click', () => {
    const html = document.documentElement;
    if(html.getAttribute('data-theme') === 'dark'){
      html.setAttribute('data-theme', 'light');
      toggleDarkModeBtn.innerHTML = '<i class="fas fa-moon"></i>';
      localStorage.setItem('bb_theme', 'light');
    } else {
      html.setAttribute('data-theme', 'dark');
      toggleDarkModeBtn.innerHTML = '<i class="fas fa-sun"></i>';
      localStorage.setItem('bb_theme', 'dark');
    }
  });
  // Load theme from localStorage
  if(localStorage.getItem('bb_theme') === 'dark'){
    document.documentElement.setAttribute('data-theme', 'dark');
    toggleDarkModeBtn.innerHTML = '<i class="fas fa-sun"></i>';
  }

  // Storage keys
  const STORAGE_KEYS = {
    employees: 'bb_employees',
    units: 'bb_units',
    attendance: 'bb_attendance'
  };

  // Default units
  const DEFAULT_UNITS = [
    "Mayorista Río Tercero",
    "Mayorista Santa Rosa",
    "Distribuidora"
  ];

  // Data holders
  let employees = [];
  let units = [];
  let attendance = {}; // { 'YYYY-MM-DD': { dni: {status, obs} } }

  // Utility functions
  function saveToStorage() {
    localStorage.setItem(STORAGE_KEYS.employees, JSON.stringify(employees));
    localStorage.setItem(STORAGE_KEYS.units, JSON.stringify(units));
    localStorage.setItem(STORAGE_KEYS.attendance, JSON.stringify(attendance));
  }

  function loadFromStorage() {
    employees = JSON.parse(localStorage.getItem(STORAGE_KEYS.employees)) || [];
    units = JSON.parse(localStorage.getItem(STORAGE_KEYS.units));
    if(!units || !Array.isArray(units) || units.length === 0){
      units = [...DEFAULT_UNITS];
      localStorage.setItem(STORAGE_KEYS.units, JSON.stringify(units));
    }
    attendance = JSON.parse(localStorage.getItem(STORAGE_KEYS.attendance)) || {};
  }

  // Calculate antigüedad en años (redondeado a 2 decimales)
  function calcularAntiguedad(fechaIngreso) {
    const ingreso = new Date(fechaIngreso);
    const hoy = new Date();
    const diffMs = hoy - ingreso;
    const diffYears = diffMs / (1000 * 60 * 60 * 24 * 365.25);
    return diffYears < 0 ? 0 : Math.floor(diffYears * 100) / 100;
  }

  // Format date to dd/mm/yyyy
  function formatDate(dateStr) {
    const d = new Date(dateStr);
    if(isNaN(d)) return '';
    return d.toLocaleDateString('es-AR');
  }

  // Validate DNI uniqueness
  function isDniUnique(dni, excludeDni = null) {
    return !employees.some(e => e.dni === dni && e.dni !== excludeDni);
  }

  // Render units in select and list
  function renderUnits() {
    const empUnitSelect = document.getElementById('empUnit');
    empUnitSelect.innerHTML = '';
    units.forEach(unit => {
      const option = document.createElement('option');
      option.value = unit;
      option.textContent = unit;
      empUnitSelect.appendChild(option);
    });

    const attUnitFilter = document.getElementById('attUnitFilter');
    if(attUnitFilter){
      attUnitFilter.innerHTML = '<option value="all" selected>Todas las unidades</option>';
      units.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit;
        option.textContent = unit;
        attUnitFilter.appendChild(option);
      });
    }

    const unitsList = document.getElementById('unitsList');
    unitsList.innerHTML = '';
    units.forEach(unit => {
      const li = document.createElement('li');
      li.className = "flex justify-between items-center py-2 px-3";
      const span = document.createElement('span');
      span.textContent = unit;
      li.appendChild(span);

      // Check if unit has employees assigned
      const hasEmployees = employees.some(e => e.unit === unit);

      const btn = document.createElement('button');
      btn.className = `text-red-600 hover:text-red-800 disabled:opacity-50 disabled:cursor-not-allowed`;
      btn.title = hasEmployees ? "No se puede eliminar: tiene empleados asignados" : "Eliminar unidad";
      btn.innerHTML = '<i class="fas fa-trash-alt"></i>';
      btn.disabled = hasEmployees;
      btn.addEventListener('click', () => {
        if(confirm(`¿Eliminar la unidad "${unit}"? Esta acción no se puede deshacer.`)) {
          units = units.filter(u => u !== unit);
          saveToStorage();
          renderUnits();
          renderEmployeeUnitOptions();
          renderEmployeesTable();
          renderReportEmployeeOptions();
          renderAttendanceTable();
        }
      });
      li.appendChild(btn);
      unitsList.appendChild(li);
    });
  }

  // Render employees table
  function renderEmployeesTable(filter = '') {
    const tbody = document.getElementById('employeesTableBody');
    tbody.innerHTML = '';
    const filterLower = filter.toLowerCase();

    const filtered = employees.filter(e => {
      return e.name.toLowerCase().includes(filterLower) || e.lastname.toLowerCase().includes(filterLower) || e.dni.includes(filterLower);
    });

    if(filtered.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 8;
      td.className = "text-center py-4 text-gray-500";
      td.textContent = "No se encontraron empleados.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    filtered.forEach(emp => {
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      tdName.className = "px-4 py-2";
      tdName.textContent = emp.name;
      tr.appendChild(tdName);

      const tdLastName = document.createElement('td');
      tdLastName.className = "px-4 py-2";
      tdLastName.textContent = emp.lastname;
      tr.appendChild(tdLastName);

      const tdDni = document.createElement('td');
      tdDni.className = "px-4 py-2";
      tdDni.textContent = emp.dni;
      tr.appendChild(tdDni);

      const tdDate = document.createElement('td');
      tdDate.className = "px-4 py-2";
      tdDate.textContent = formatDate(emp.date);
      tr.appendChild(tdDate);

      const tdAnt = document.createElement('td');
      tdAnt.className = "px-4 py-2";
      tdAnt.textContent = calcularAntiguedad(emp.date).toFixed(2);
      tr.appendChild(tdAnt);

      const tdPos = document.createElement('td');
      tdPos.className = "px-4 py-2";
      tdPos.textContent = emp.position;
      tr.appendChild(tdPos);

      const tdUnit = document.createElement('td');
      tdUnit.className = "px-4 py-2";
      tdUnit.textContent = emp.unit;
      tr.appendChild(tdUnit);

      const tdActions = document.createElement('td');
      tdActions.className = "px-4 py-2 text-center flex justify-center gap-2";

      // Edit button
      const btnEdit = document.createElement('button');
      btnEdit.className = "text-indigo-600 hover:text-indigo-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded p-1";
      btnEdit.title = "Editar empleado";
      btnEdit.setAttribute('aria-label', `Editar empleado ${emp.name} ${emp.lastname}`);
      btnEdit.innerHTML = '<i class="fas fa-edit"></i>';
      btnEdit.addEventListener('click', () => {
        fillEmployeeForm(emp);
        window.scrollTo({top:0, behavior:'smooth'});
      });
      tdActions.appendChild(btnEdit);

      // Delete button
      const btnDel = document.createElement('button');
      btnDel.className = "text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 rounded p-1";
      btnDel.title = "Eliminar empleado y sus asistencias";
      btnDel.setAttribute('aria-label', `Eliminar empleado ${emp.name} ${emp.lastname}`);
      btnDel.innerHTML = '<i class="fas fa-trash-alt"></i>';
      btnDel.addEventListener('click', () => {
        if(confirm(`¿Eliminar al empleado "${emp.name} ${emp.lastname}" y todas sus asistencias?`)) {
          deleteEmployee(emp.dni);
        }
      });
      tdActions.appendChild(btnDel);

      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    });
  }

  // Fill employee form for editing
  function fillEmployeeForm(emp) {
    document.getElementById('empName').value = emp.name;
    document.getElementById('empLastName').value = emp.lastname;
    document.getElementById('empDNI').value = emp.dni;
    document.getElementById('empDNI').disabled = true; // DNI no editable
    document.getElementById('empDate').value = emp.date;
    document.getElementById('empPosition').value = emp.position;
    document.getElementById('empUnit').value = emp.unit;
    document.getElementById('empSubmitBtn').innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
    editingDni = emp.dni;
  }

  // Clear employee form
  function clearEmployeeForm() {
    document.getElementById('employeeForm').reset();
    document.getElementById('empDNI').disabled = false;
    document.getElementById('empSubmitBtn').innerHTML = '<i class="fas fa-plus"></i> Agregar Empleado';
    editingDni = null;
  }

  // Delete employee and their attendance
  function deleteEmployee(dni) {
    employees = employees.filter(e => e.dni !== dni);
    // Remove attendance for this dni
    for(const date in attendance){
      if(attendance[date][dni]){
        delete attendance[date][dni];
      }
    }
    saveToStorage();
    renderEmployeesTable(document.getElementById('empSearch').value);
    renderAttendanceTable(document.getElementById('attSearch').value, document.getElementById('attDate').value || todayISO, document.getElementById('attUnitFilter').value);
    renderReportEmployeeOptions();
    renderUnits();
  }

  // Render employee options for attendance and reports
  function renderEmployeeUnitOptions() {
    const empUnitSelect = document.getElementById('empUnit');
    empUnitSelect.innerHTML = '';
    units.forEach(unit => {
      const option = document.createElement('option');
      option.value = unit;
      option.textContent = unit;
      empUnitSelect.appendChild(option);
    });
  }

  function renderReportEmployeeOptions() {
    const select = document.getElementById('reportEmpSelect');
    select.innerHTML = '<option value="all" selected>Todos los empleados</option>';
    employees.forEach(emp => {
      const option = document.createElement('option');
      option.value = emp.dni;
      option.textContent = emp.name + ' ' + emp.lastname + ' (' + emp.dni + ')';
      select.appendChild(option);
    });
  }

  // Render attendance table for selected date and filtered employees
  function renderAttendanceTable(filter = '', date = todayISO, unitFilter = 'all') {
    const tbody = document.getElementById('attendanceTableBody');
    tbody.innerHTML = '';
    const filterLower = filter.toLowerCase();

    let filtered = employees.filter(e => {
      return e.name.toLowerCase().includes(filterLower) || e.lastname.toLowerCase().includes(filterLower) || e.dni.includes(filterLower);
    });

    if(unitFilter !== 'all'){
      filtered = filtered.filter(e => e.unit === unitFilter);
    }

    if(filtered.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 7;
      td.className = "text-center py-4 text-gray-500";
      td.textContent = "No se encontraron empleados.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    filtered.forEach(emp => {
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      tdName.className = "px-4 py-2";
      tdName.textContent = emp.name;
      tr.appendChild(tdName);

      const tdLastName = document.createElement('td');
      tdLastName.className = "px-4 py-2";
      tdLastName.textContent = emp.lastname;
      tr.appendChild(tdLastName);

      const tdDni = document.createElement('td');
      tdDni.className = "px-4 py-2";
      tdDni.textContent = emp.dni;
      tr.appendChild(tdDni);

      const tdUnit = document.createElement('td');
      tdUnit.className = "px-4 py-2";
      tdUnit.textContent = emp.unit;
      tr.appendChild(tdUnit);

      const tdPos = document.createElement('td');
      tdPos.className = "px-4 py-2";
      tdPos.textContent = emp.position;
      tr.appendChild(tdPos);

      const tdStatus = document.createElement('td');
      tdStatus.className = "px-4 py-2 text-center";

      const selectStatus = document.createElement('select');
      selectStatus.name = `status_${emp.dni}`;
      selectStatus.className = "border border-gray-300 rounded-md p-1 w-full max-w-[150px] focus:outline-none focus:ring-2 focus:ring-indigo-500";
      const optionsStatus = [
        {value: 'asistio', label: 'Asistió'},
        {value: 'no_asistio', label: 'No asistió'},
        {value: 'avisado', label: 'No asistió pero avisó'},
        {value: 'vacaciones', label: 'De vacaciones'}
      ];
      optionsStatus.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.label;
        selectStatus.appendChild(option);
      });

      // Set current value if exists
      if(attendance[date] && attendance[date][emp.dni]){
        selectStatus.value = attendance[date][emp.dni].status;
      } else {
        selectStatus.value = 'asistio';
      }
      tdStatus.appendChild(selectStatus);
      tr.appendChild(tdStatus);

      const tdObs = document.createElement('td');
      tdObs.className = "px-4 py-2";

      const inputObs = document.createElement('input');
      inputObs.type = 'text';
      inputObs.name = `obs_${emp.dni}`;
      inputObs.placeholder = 'Observaciones (opcional)';
      inputObs.className = "border border-gray-300 rounded-md p-1 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500";
      if(attendance[date] && attendance[date][emp.dni]){
        inputObs.value = attendance[date][emp.dni].obs || '';
      }
      tdObs.appendChild(inputObs);
      tr.appendChild(tdObs);

      tbody.appendChild(tr);
    });
  }

  // Export employees to XLSX with professional formatting
  function exportEmployeesXLSX() {
    if(employees.length === 0){
      alert('No hay empleados para exportar.');
      return;
    }
    const wb = XLSX.utils.book_new();
    const wsData = [
      ["Nombre", "Apellido", "DNI", "Fecha de ingreso", "Antigüedad (años)", "Puesto", "Unidad de negocio"]
    ];
    employees.forEach(emp => {
      wsData.push([
        emp.name,
        emp.lastname,
        emp.dni,
        formatDate(emp.date),
        calcularAntiguedad(emp.date).toFixed(2),
        emp.position,
        emp.unit
      ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Set column widths (approximate)
    ws['!cols'] = [
      {wch: 15}, // Nombre
      {wch: 20}, // Apellido
      {wch: 12}, // DNI
      {wch: 15}, // Fecha
      {wch: 18}, // Antigüedad
      {wch: 20}, // Puesto
      {wch: 25}  // Unidad
    ];

    // Style header row
    const range = XLSX.utils.decode_range(ws['!ref']);
    for(let C = range.s.c; C <= range.e.c; ++C) {
      const cellAddress = XLSX.utils.encode_cell({r:0, c:C});
      if(!ws[cellAddress]) continue;
      ws[cellAddress].s = {
        font: {bold: true, color: {rgb: "FFFFFF"}},
        fill: {fgColor: {rgb: "4F46E5"}},
        alignment: {horizontal: "center", vertical: "center"}
      };
    }

    XLSX.utils.book_append_sheet(wb, ws, "Nómina Luconi");
    XLSX.writeFile(wb, "nomina_luconi_empleados.xlsx");
  }

  // Export attendance to XLSX with professional formatting
  function exportAttendanceXLSX() {
    const allDates = Object.keys(attendance).sort();
    if(allDates.length === 0){
      alert('No hay asistencias para exportar.');
      return;
    }
    // Group by month-year for sheets
    const wb = XLSX.utils.book_new();

    // Group attendance by month-year
    const attendanceByMonth = {};
    allDates.forEach(date => {
      const d = new Date(date);
      const monthYear = d.toLocaleDateString('es-AR', {year:'numeric', month:'long'});
      if(!attendanceByMonth[monthYear]) attendanceByMonth[monthYear] = [];
      attendanceByMonth[monthYear].push(date);
    });

    for(const monthYear in attendanceByMonth){
      const dates = attendanceByMonth[monthYear];
      const wsData = [
        ["Nombre", "Apellido", "DNI", "Fecha", "Estado de asistencia", "Unidad", "Puesto", "Observaciones"]
      ];
      dates.forEach(date => {
        const dayAttendance = attendance[date];
        for(const dni in dayAttendance){
          const emp = employees.find(e => e.dni === dni);
          if(!emp) continue;
          const att = dayAttendance[dni];
          let estadoTexto = '';
          switch(att.status){
            case 'asistio': estadoTexto = 'Asistió'; break;
            case 'no_asistio': estadoTexto = 'No asistió'; break;
            case 'avisado': estadoTexto = 'No asistió pero avisó'; break;
            case 'vacaciones': estadoTexto = 'De vacaciones'; break;
            default: estadoTexto = att.status;
          }
          wsData.push([
            emp.name,
            emp.lastname,
            dni,
            formatDate(date),
            estadoTexto,
            emp.unit,
            emp.position,
            att.obs || ''
          ]);
        }
      });
      const ws = XLSX.utils.aoa_to_sheet(wsData);

      // Set column widths
      ws['!cols'] = [
        {wch: 15}, // Nombre
        {wch: 20}, // Apellido
        {wch: 12}, // DNI
        {wch: 15}, // Fecha
        {wch: 25}, // Estado
        {wch: 20}, // Unidad
        {wch: 20}, // Puesto
        {wch: 30}  // Observaciones
      ];

      // Style header row
      const range = XLSX.utils.decode_range(ws['!ref']);
      for(let C = range.s.c; C <= range.e.c; ++C) {
        const cellAddress = XLSX.utils.encode_cell({r:0, c:C});
        if(!ws[cellAddress]) continue;
        ws[cellAddress].s = {
          font: {bold: true, color: {rgb: "FFFFFF"}},
          fill: {fgColor: {rgb: "4F46E5"}},
          alignment: {horizontal: "center", vertical: "center"}
        };
      }

      XLSX.utils.book_append_sheet(wb, ws, `Asistencias ${monthYear}`);
    }

    XLSX.writeFile(wb, "asistencias_luconi.xlsx");
  }

  // Generate report data
  function generateReport(empDni, fromDate, toDate) {
    // Filter employees to report
    let emps = [];
    if(empDni === 'all'){
      emps = [...employees];
    } else {
      const emp = employees.find(e => e.dni === empDni);
      if(emp) emps = [emp];
    }
    if(emps.length === 0) return [];

    // Date range
    const from = fromDate ? new Date(fromDate) : null;
    const to = toDate ? new Date(toDate) : null;

    // Prepare report array
    const report = [];

    emps.forEach(emp => {
      let asistidos = 0;
      let noAsistidos = 0;
      let avisados = 0;
      let vacaciones = 0;
      let totalDias = 0;

      // Iterate attendance dates
      for(const dateStr in attendance){
        const dateObj = new Date(dateStr);
        if(from && dateObj < from) continue;
        if(to && dateObj > to) continue;

        const dayAtt = attendance[dateStr];
        if(dayAtt && dayAtt[emp.dni]){
          totalDias++;
          const status = dayAtt[emp.dni].status;
          switch(status){
            case 'asistio': asistidos++; break;
            case 'no_asistio': noAsistidos++; break;
            case 'avisado': avisados++; break;
            case 'vacaciones': vacaciones++; break;
          }
        }
      }

      const totalConsiderados = asistidos + noAsistidos + avisados + vacaciones;
      const porcentaje = totalConsiderados > 0 ? Math.round((asistidos / totalConsiderados) * 100) + '%' : 'N/A';

      report.push({
        name: emp.name,
        lastname: emp.lastname,
        dni: emp.dni,
        asistidos,
        noAsistidos,
        avisados,
        vacaciones,
        porcentaje
      });
    });

    return report;
  }

  // Render report table
  function renderReportTable(reportData) {
    const tbody = document.getElementById('reportTableBody');
    tbody.innerHTML = '';
    if(reportData.length === 0){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 8;
      td.className = "text-center py-4 text-gray-500";
      td.textContent = "No hay datos para mostrar.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    reportData.forEach(r => {
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      tdName.className = "px-4 py-2";
      tdName.textContent = r.name;
      tr.appendChild(tdName);

      const tdLastName = document.createElement('td');
      tdLastName.className = "px-4 py-2";
      tdLastName.textContent = r.lastname;
      tr.appendChild(tdLastName);

      const tdDni = document.createElement('td');
      tdDni.className = "px-4 py-2";
      tdDni.textContent = r.dni;
      tr.appendChild(tdDni);

      const tdAsistidos = document.createElement('td');
      tdAsistidos.className = "px-4 py-2";
      tdAsistidos.textContent = r.asistidos;
      tr.appendChild(tdAsistidos);

      const tdNoAsistidos = document.createElement('td');
      tdNoAsistidos.className = "px-4 py-2";
      tdNoAsistidos.textContent = r.noAsistidos;
      tr.appendChild(tdNoAsistidos);

      const tdAvisados = document.createElement('td');
      tdAvisados.className = "px-4 py-2";
      tdAvisados.textContent = r.avisados;
      tr.appendChild(tdAvisados);

      const tdVacaciones = document.createElement('td');
      tdVacaciones.className = "px-4 py-2";
      tdVacaciones.textContent = r.vacaciones;
      tr.appendChild(tdVacaciones);

      const tdPorcentaje = document.createElement('td');
      tdPorcentaje.className = "px-4 py-2";
      tdPorcentaje.textContent = r.porcentaje;
      tr.appendChild(tdPorcentaje);

      tbody.appendChild(tr);
    });
  }

  // Export report to XLSX
  function exportReportXLSX(reportData) {
    if(reportData.length === 0){
      alert('No hay datos para exportar.');
      return;
    }
    const wb = XLSX.utils.book_new();
    const wsData = [
      ["Nombre", "Apellido", "DNI", "Días Asistidos", "Días No Asistidos", "Días Avisados", "Días de Vacaciones", "Porcentaje de Asistencia"]
    ];
    reportData.forEach(r => {
      wsData.push([
        r.name,
        r.lastname,
        r.dni,
        r.asistidos,
        r.noAsistidos,
        r.avisados,
        r.vacaciones,
        r.porcentaje
      ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Set column widths
    ws['!cols'] = [
      {wch: 15}, // Nombre
      {wch: 20}, // Apellido
      {wch: 12}, // DNI
      {wch: 15}, // Días Asistidos
      {wch: 18}, // Días No Asistidos
      {wch: 15}, // Días Avisados
      {wch: 18}, // Días Vacaciones
      {wch: 22}  // Porcentaje
    ];

    // Style header row
    const range = XLSX.utils.decode_range(ws['!ref']);
    for(let C = range.s.c; C <= range.e.c; ++C) {
      const cellAddress = XLSX.utils.encode_cell({r:0, c:C});
      if(!ws[cellAddress]) continue;
      ws[cellAddress].s = {
        font: {bold: true, color: {rgb: "FFFFFF"}},
        fill: {fgColor: {rgb: "4F46E5"}},
        alignment: {horizontal: "center", vertical: "center"}
      };
    }

    XLSX.utils.book_append_sheet(wb, ws, "Reporte Luconi");
    XLSX.writeFile(wb, "reporte_luconi.xlsx");
  }

  // Print report
  function printReport() {
    const reportTable = document.querySelector('#reportTableBody').parentElement.outerHTML;
    const printWindow = window.open('', '', 'width=900,height=700');
    printWindow.document.write('<html><head><title>Reporte de Asistencia - Luconi</title>');
    printWindow.document.write('<style>body{font-family:sans-serif;padding:20px;}table{border-collapse:collapse;width:100%;}th,td{border:1px solid #444;padding:8px;text-align:left;}th{background:#4F46E5;color:#fff;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write('<h1>Reporte de Asistencia - Luconi</h1>');
    printWindow.document.write(reportTable);
    printWindow.document.write('</body></html>